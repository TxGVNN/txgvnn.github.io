---
title: "Literate Devops vá»›i Emacs"
date: 2022-03-04T07:27:19Z
tags: [emacs, stateless]
draft: false
---

VÃ­ dá»¥ nhÆ° video nÃ y Ä‘Ã¢y [[https://www.youtube.com/watch?v=dljNabciEGg][youtube.com/Literate Devops with Emacs]]

Hiá»ƒu Ä‘Æ¡n giáº£n lÃ  giá» chÃºng ta cáº§n ~everything as code~, cáº§n ~reproducible~, tÄƒng kháº£ nÄƒng ~stateless~ (hÃ£y nhÆ° [[/post/gnu-guix-os/][Guix]])

* Sá»­ dá»¥ng org-babel
Vá»›i [[https://orgmode.org/worg/org-contrib/babel/intro.html][org-babel]] thÃ¬ cÃ¡c Ä‘oáº¡n code sáº½ Ä‘Æ°á»£c viáº¿t trong cáº·p ~#+BEGIN_SRC NGÃ”N-NGá»®-THá»°C-THI~ vÃ  ~#+END_SRC~ vá»›i cÃ¡c option nhÆ° thá»±c thi á»Ÿ thÆ° má»¥c nÃ o ~:dir~,...

CÃ¡c vÃ­ dá»¥ mÃ¬nh dÃ¹ng.

**  CÃ i cáº¯m cÃ¡c tool cáº§n thiáº¿t cho mÃ¡y mÃ¬nh
#+begin_src org
* Build PC
** Setup emacs
,#+BEGIN_SRC compile
sudo apt-get update
sudo apt-get install -y emacs-nox
# Setup dotfiles
curl https://txgvnn.github.io/sh/dots | bash
,#+END_SRC

** Setup minikube
,#+BEGIN_SRC compile
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
,#+END_SRC

,#+RESULTS:

,#+BEGIN_SRC sh
minikube config set driver kvm2
minikube config set kubernetes-version v1.20.15
,#+END_SRC

#+end_src


** Äá»ƒ backup cÃ¡c file secret, config cÃ¡c kiá»ƒu
#+BEGIN_SRC org
,#+NAME: gitlab-token
,#+BEGIN_SRC sh :results output
cat ~/projects/infra-deployment/gitlab/terraform.tfvars
,#+END_SRC

,#+RESULTS: gitlab-token
: gitlab_token="XYZ-token"

#+end_src

** Cáº§n restore láº¡i thÃ¬ nhÆ° sau
#+begin_src org
,#+BEGIN_SRC sh :var INPUT=gitlab-token
cat > ~/projects/infra-deployment/gitlab/terraform.tfvars << EOF
$INPUT
EOF
,#+END_SRC

,#+RESULTS:
#+end_src

org-mode sáº½ láº¥y biáº¿n INPUT báº±ng giÃ¡ trá»‹ cá»§a name gitlab-token trÃªn kia.

Trong trÆ°á»ng há»£p chÃºng ta init má»›i tá»« chá»© chÆ°a cÃ³ dá»¯ liá»‡u backup thÃ¬ chá»‰ cáº§n Ä‘á»•i ~#+RESULTS~ thÃ nh ~#+NAME~

Äá»‘i vá»›i cÃ¡c file ~org~ chá»© thÃ´ng tin nháº¡y cáº£m chÃºng ta nÃªn dÃ¹ng file lÃ  ~org.gpg~ Ä‘á»ƒ Ä‘Æ°á»£c encrypt báº±ng ~gpg~

** Setup Ä‘Æ°á»£c trÃªn cÃ¡c mÃ¡y remote thÃ´ng qua TRAMP nhÆ° ssh

#+begin_src org
,#+BEGIN_SRC sh :dir /ssh:root@the-sun:/
apt-get install -y nginx
,#+END_SRC
#+end_src

** Hoáº·c Ä‘Æ¡n giáº£n lÃ  viáº¿t README cho dá»± Ã¡n mÃ  mÃ¬nh cÅ©ng cháº¡y Ä‘Æ°á»£c luÃ´n
ChÃºng ta cÃ³ thá»ƒ export ~README.org~ -> ~README.md~
#+begin_src org
* Build docker image
,#+BEGIN_SRC sh
make build-image
,#+END_SRC

* Cháº¡y thá»­ vá»›i docker-compose
,#+BEGIN_SRC compile
docker-compose up
,#+END_SRC
#+end_src

* Sá»­ dá»¥ng [[http://angg.twu.net/#eev][eev]] package
#+begin_src emacs-lisp
(use-package eev
  :ensure t :defer 1
  :config (require 'eev-load)
  (global-set-key (kbd "<f8>") #'eepitch-this-line)
  (global-set-key (kbd "C-<f8>") #'eewrap-eepitch))
#+end_src

Má»™t sá»‘ bÃ i toÃ¡n phá»©c táº¡p hÆ¡n thÃ¬ ta cáº§n dÃ¹ng [[http://angg.twu.net/#eev][eev]]. Cá»¥ thá»ƒ eev cÃ³ tÃ­nh nÄƒng nhÆ° kmacro váº­y. VÃ­ dá»¥ chÃºng ta cáº§n má»Ÿ terminal ssh qua vm1 rá»“i láº¡i ssh qua vm2 rá»“i ssh vm3.
~eev~ lÃ  giáº£i phÃ¡p.

Khi dÃ¹ng eev cháº¡y ~(eepitch-shell)~ nÃ³ sáº½ báº­t thÃªm 1 buffer shell. VÃ  cá»© nháº¥n f8 Ä‘á»ƒ nÃ³ copy tá»«ng dÃ²ng á»Ÿ bÃªn ~code~ sang bÃªn ~shell~.
NÃ³ há»— trá»£ ráº¥t nhiá»u loáº¡i Ä‘á»ƒ mÃ¬nh tÆ°Æ¡ng tÃ¡c nhÆ° ~eepitch-ansiterm~, ~eepitch-python~,...

VÃ­ dá»¥ nhÆ° mÃ¬nh cáº§n resize disk cho 1 con VM quáº£n lÃ½ báº±ng virsh á»Ÿ server ~the-sun~ nhÆ° sau:
#+begin_src org

* Resize disk to 40G
,#+begin_src sh :eval no
# (eepitch-shell)
# (eepitch-kill)
# (eepitch-shell)
ssh root@the-sun

virsh start base

cat > /tmp/disk.yaml << EOF
<disk type='file' device='disk'>
  <driver name='qemu' type='qcow2'/>
  <source file='/var/lib/libvirt/images/disk-can-resize.img'/>
  <target dev='vdb' bus='virtio'/>
</disk>
EOF

virsh attach-device base /tmp/disk.yaml

virsh console base # Äoáº¡n nÃ y sáº½ pháº£i nháº£y sang shell Ä‘á»ƒ nháº­p pass

lsblk
parted /dev/vdb
resizepart 1 40GB
quit

e2fsck -f /dev/vdb1
resize2fs -p /dev/vdb1

^] # Äoáº¡n nÃ y Ä‘á»ƒ thoÃ¡t virsh console

virsh shutdown base

virsh list --all
,#+end_src
#+end_src

~eev~ thÃ¬ tháº­t cá»±c ká»³ linh Ä‘á»™ng, cÃ³ thá»ƒ gá»i lÃ  ~log as code~ hay ~code as log~ cÅ©ng Ä‘Æ°á»£c Ä‘áº¥y nhá»‰.
